// Generated by CoffeeScript 1.6.1
(function() {
  var path, plugin;

  path = require('path');

  plugin = function(assembot) {
    var Resource, cat, log, runtime_path, settee_was_used, shelljs, test, tryRequireResolve;
    Resource = assembot.Resource, tryRequireResolve = assembot.tryRequireResolve, log = assembot.log, shelljs = assembot.shelljs;
    cat = shelljs.cat, test = shelljs.test;
    settee_was_used = false;
    runtime_path = null;
    tryRequireResolve('settee-templates', function(err, libpath) {
      runtime_path = err != null ? (log.debug("Could not detect path of settee-templates."), null) : path.resolve(libpath, '../../../settee.runtime.js');
      log.debug("Path of settee-templates is");
      return log.debug(runtime_path);
    });
    assembot.addProcessor('js').ext('.settee').requires('settee-templates').build(function(settee) {
      return function(source, opts, converted) {
        var output;
        settee_was_used = true;
        output = "settee= require('runtime/settee');\nmodule.exports=settee(" + (settee.precompile(source)) + ");";
        return converted(null, output, opts);
      };
    });
    assembot.before('render', function(bot) {
      return settee_was_used = false;
    });
    return assembot.after('render', function(bot) {
      if (settee_was_used) {
        if (test('-f', runtime_path)) {
          return bot.resources.add(new Resource('runtime/settee.js', cat(runtime_path)));
        } else {
          throw new Error("Cannot embed Settee runtime! Not found at " + runtime_path);
        }
      }
    });
  };

  module.exports = plugin;

}).call(this);
