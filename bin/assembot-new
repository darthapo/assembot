#!/usr/bin/env coffee
_= require '../lib/assembot/util'
cli= require 'commander'
pkg= require '../package'
log= require '../lib/assembot/log'
defaults= require '../lib/assembot/defaults'
path= require 'path'
{spawn}= require('child_process')
{test, cat, cd, mkdir, exec}= require 'shelljs'
{loadOptions}= require '../lib/assembot'

cli
  .version(pkg.version)
  .option('-v, --verbose', 'force installation')
  .option('-q, --quiet', 'force installation')

cli
  .command('*')
  .description("project directory name")
  .action((name)->
    build_project name     
  )

log.say ''

if process.argv.length is 2
  log.say "I am an advanced Bot, yes. But my telepathic circuits aren't ready yet.\n"
  log.say "Please enter a project name!"


build_project= (name)->
  projectpath= path.resolve "./#{ name }"
  if test '-e', projectpath
    log.say "#{ name} already exists at this location!"
  else
    log.say "create: #{ name }"
    mkdir projectpath

    cd projectpath

    log.say "create: #{ name }/source"
    mkdir "source"
    
    log.say "create: #{ name }/source/main.coffee"
    content.mainCoffee.replace(/APPNAME/g, name).to "source/main.coffee"
    
    log.say "create: #{ name }/source/main.styl"
    content.mainStylus.replace(/APPNAME/g, name).to "source/main.styl"
    
    log.say "create: #{ name }/public"
    mkdir "public"

    log.say "create: #{ name }/public/index.html"
    content.indexHtml.replace(/APPNAME/g, name).to "public/index.html"
    
    log.say "create: #{ name }/notes"
    mkdir "notes"

    log.say "create: #{ name }/notes/ideas.md"
    content.ideas.replace(/APPNAME/g, name).to "notes/ideas.md"

    log.say "create: #{ name }/notes/todos.md"
    content.todos.replace(/APPNAME/g, name).to "notes/todos.md"

    log.say "create: #{ name }/.gitignore"
    "node_modules".to('.gitignore')
    
    log.say "create: #{ name }/readme.md"
    content.readme.replace(/APPNAME/g, name).to "readme.md"
    
    proc = spawn("assembot", ["init"], { stdio: 'inherit', customFds: [0, 1, 2] })
    proc.on('exit', (code)->
      if (code == 127)
        console.error("An error occured with `assembot init`, you'll have to run it yourself.");
    )

content=
  readme: """
    # APPNAME

    ## Install

        npm install APPNAME

    ## Usage

    Yeah, you should probably say a few words about APPNAME here.
    """

  mainCoffee: """
    # APPNAME main

    console.log "Ready."
    """

  mainStylus: """
    // APPNAME
    @import 'nib'

    global-reset()

    body
      font-family "Helvetica Neue", Helvetica, Sans-Serif
    """

  ideas: """
    # APPNAME Ideas
    - Do cool stuff!
    """

  todos: """
    # APPNAME Todos
    - Write docs
    - Flesh out readme.md
    - Release APPNAME!
    """

  indexHtml: """<!DOCTYPE html>
    <html lang="en"  class="nojs">
      <head>
        <meta charset="utf-8" />
        <title>APPNAME</title>
        <link rel="stylesheet" type="text/css" href="theme.css">
      </head>
      <body>
        Loading...
      </body>
      <script src="app.js"></script>
    </html>"""

cli
  .parse(process.argv);

log.level 0 if cli.quiet
log.level 2 if cli.verbose
