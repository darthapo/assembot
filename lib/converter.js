// Generated by CoffeeScript 1.5.0
(function() {
  var addConvertor, addCssConvertor, addJsConvertor, api, assembot_package, fs, path, project_package, project_root, type_db, validType, _;

  path = require('path');

  fs = require('fs');

  _ = require('./util');

  project_root = process.cwd();

  assembot_package = require('../package');

  project_package = (function() {
    try {
      return require("" + project_root + path.sep + "package");
    } catch (ex) {
      return {};
    }
  })();

  type_db = {
    ".js": {
      types: [],
      handlers: {}
    },
    ".css": {
      types: [],
      handlers: {}
    }
  };

  validType = function(target) {
    if (target[0] === '.') {
      return target;
    } else {
      return "." + target;
    }
  };

  module.exports = api = {
    addFor: function(target, type, converter) {
      target = validType(target);
      type = validType(type);
      type_db[target].types.push(type);
      type_db[target].handlers[type] = converter;
      return this;
    },
    validTypeFor: function(target, ext) {
      var type;
      target = validType(target);
      type = validType(ext);
      if (type_db[target] != null) {
        return type_db[target].types.indexOf(type) >= 0;
      } else {
        return false;
      }
    },
    buildSourceFor: function(target, fullpath, info, callback) {
      var converter, ext, source;
      target = validType(target);
      ext = path.extname(fullpath);
      source = fs.readFileSync(fullpath, 'utf8');
      converter = type_db[target].handlers[ext];
      converter(this.replaceTokens(String(source), info), info, callback);
      return this;
    },
    tokenParser: /(\{%\-([ a-zA-Z0-9\._]*)\-%\})/g,
    replaceTokens: function(string, info) {
      if (info.replaceTokens && this.tokenParser.test(string)) {
        return string.replace(this.tokenParser, function(match, token, value, loc, src) {
          var data, first_part, key, part, parts, _i, _len;
          data = info;
          parts = value.split('.');
          first_part = parts.shift().trim();
          switch (first_part) {
            case 'package':
              data = project_package;
              break;
            case 'assembot':
              data = assembot_package;
              break;
            case 'NOW':
              data = new Date();
              break;
            default:
              data = info[first_part];
          }
          for (_i = 0, _len = parts.length; _i < _len; _i++) {
            part = parts[_i];
            key = part.trim();
            data = data[key];
          }
          return String(data);
        });
      } else {
        return string;
      }
    }
  };

  addConvertor = function(target, type, modules, handler) {
    var args, converter, module, _i, _len;
    try {
      if (!_.isArray(modules)) {
        modules = [modules];
      }
      args = [];
      for (_i = 0, _len = modules.length; _i < _len; _i++) {
        module = modules[_i];
        args.push(_.tryRequireLocalFirst(module));
      }
      converter = handler.apply(handler, args);
      return api.addFor(target, type, function(s, o, c) {
        var file;
        try {
          return converter(s, o, c);
        } catch (ex) {
          file = "" + o.current_file.path + o.current_file.ext;
          return c(new Error("Transpiler error for " + file + ": " + ex.message), null, o);
        }
      });
    } catch (ex) {
      return api.addFor(target, type, function() {
        throw "Module(s) '" + (modules.join("'")) + "' cannot be found!";
      });
    }
  };

  addJsConvertor = function(type, modules, handler) {
    return addConvertor('js', type, modules, handler);
  };

  addCssConvertor = function(type, modules, handler) {
    return addConvertor('css', type, modules, handler);
  };

  addJsConvertor('.js', [], function() {
    return function(source, opts, converted) {
      return converted(null, source, opts);
    };
  });

  addJsConvertor('.html', [], function() {
    return function(source, opts, converted) {
      return converted(null, "module.exports=" + (JSON.stringify(source)) + ";", opts);
    };
  });

  addJsConvertor('.coffee', 'coffee-script', function(coffee) {
    return function(source, opts, converted) {
      var output, _ref;
      opts = opts.coffee || {};
      if ((_ref = opts.bare) == null) {
        opts.bare = true;
      }
      output = coffee.compile(source, opts);
      return converted(null, output, opts);
    };
  });

  addJsConvertor('.litcoffee', 'coffee-script', function(coffee) {
    return function(source, opts, converted) {
      var output, _ref, _ref1;
      opts = opts.coffee || {};
      if ((_ref = opts.bare) == null) {
        opts.bare = true;
      }
      if ((_ref1 = opts.literate) == null) {
        opts.literate = true;
      }
      output = coffee.compile(source, opts);
      return converted(null, output, opts);
    };
  });

  addJsConvertor('.eco', 'eco', function(eco) {
    return function(source, opts, converted) {
      var output;
      output = eco.precompile(source);
      return converted(null, output, opts);
    };
  });

  addJsConvertor('.json', [], function() {
    return function(source, opts, converted) {
      var data;
      data = JSON.parse(source);
      return converted(null, "module.exports= " + (JSON.stringify(data)) + ";", opts);
    };
  });

  addCssConvertor('.css', [], function() {
    return function(source, opts, converted) {
      return converted(null, source, opts);
    };
  });

  addCssConvertor('.less', 'less', function(less) {
    return function(source, opts, converted) {
      return less.render(source, function(err, css) {
        if (err != null) {
          converted(err, null, opts);
        }
        return converted(null, css, opts);
      });
    };
  });

  addCssConvertor('.styl', ['stylus', 'nib'], function(stylus, nib) {
    var load_paths;
    load_paths = [process.cwd(), path.dirname(__dirname)];
    return function(source, opts, converted) {
      return stylus(source).set('filename', opts.current_file.filename || 'generated.css').set('paths', load_paths).use(nib()).render(function(err, css) {
        if (err != null) {
          return converted(err, null, opts);
        } else {
          return converted(null, css, opts);
        }
      });
    };
  });

}).call(this);
