#!/usr/bin/env coffee
_= require '../lib/assembot/util'
cli= require 'commander'
pkg= require '../package'
log= require '../lib/assembot/log'
defaults= require '../lib/assembot/defaults'
path= require 'path'
{spawn}= require('child_process')
{test, cat, cd, mkdir, exec}= require 'shelljs'
{loadOptions}= require '../lib/assembot'

cli
  .version(pkg.version)
  .option('-v, --verbose', 'force installation')
  .option('-q, --quiet', 'force installation')

cli
  .command('*')
  .description("project directory name")
  .action((name)->
    build_project name     
  )

log.say ''

if process.argv.length is 2
  log.say "I am an advanced Bot, yes. But my telepathic circuits aren't ready yet.\n"
  log.say "Please enter a project name!"


build_project= (name)->
  projectpath= path.resolve "./#{ name }"
  if test '-e', projectpath
    log.say "#{ name} already exists at this location!"
  else
    log.say "create: #{ name }"
    mkdir projectpath
    cd projectpath
    log.say "create: #{ name }/source"
    mkdir "source"
    log.say "create: #{ name }/public"
    mkdir "public"
    log.say "create: #{ name }/public/index.html"
    """<!DOCTYPE html>
    <html lang="en"  class="nojs">
      <head>
        <meta charset="utf-8" />
        <title>APPNAME</title>
        <link rel="stylesheet" type="text/css" href="theme.css">
      </head>
      <body>
        Loading...
      </body>
      <script src="app.js"></script>
    </html>""".to "public/index.html"
    # exec "touch public/index.html"
    log.say "create: #{ name }/notes"
    mkdir "notes"
    log.say "create: #{ name }/ideas.md"
    exec "touch notes/ideas.md"
    log.say "create: #{ name }/todos.md"
    exec "touch notes/todos.md"
    log.say "create: #{ name }/.gitignore"
    "node_modules".to('.gitignore')
    log.say "create: #{ name }/readme.md"
    exec "touch readme.md"
    # exec "assembot init", async:yes
    # proc = spawn("assembot", ["init"], { stdio: 'inherit', customFds: [0, 1, 2] })
    proc = spawn("assembot", ["init"], { stdio: 'inherit', customFds: [0, 1, 2] })
    proc.on('exit', (code)->
      if (code == 127)
        console.error("An error occured with `assembot init`, you'll have to run it yourself.");
    )



cli
  .parse(process.argv);

log.level 0 if cli.quiet
log.level 2 if cli.verbose
