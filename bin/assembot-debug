#!/usr/bin/env coffee

cli= require 'commander'
pkg= require '../package'
{assembot, _, loadTargets, loadOptions}= require '../lib/index'
log= require '../lib/log'

cli
  .version(pkg.version)
  .parse(process.argv);

# Show everything!
log.level 3

log.info ''
log.info "Building..."

options= loadOptions()

targets = []

targets.push {target, opts} for target, opts of loadTargets(options)

buildIt= ->
  if targets.length is 0
    notify.emit 'done', options
    log.info "Done"
  else
    {target, opts}= targets.shift()
    log.debug "Target:", target
    log.debug "Configuration:"
    log.debug opts
    bot= assembot target, opts
    bot.build().then buildIt

buildIt()
